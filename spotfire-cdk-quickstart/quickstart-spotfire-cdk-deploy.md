# Quick start: Deploy (Consumers)

## Overview

This quick start guide describes how to **DEPLOY** Spotfire from your by consuming pre-built container images and Helm charts.

This is a short step by step Spotfire CDK quick start: like the Spotfire CDK, but in short format, with compressed steps and explanations.

For more detailed information, see the [Cloud Deployment Kit for SpotfireÂ®](https://github.com/spotfiresoftware/spotfire-cloud-deployment-kit/tree/main/).

**Note**: The purpose of this quickstart example is to provide a starting point for automatic deployment of Spotfire.
This quickstart is not for production usage.
This quickstart example can be easily extended and customized for production usage.

## Prerequisites

- You have a Linux host for using the artifacts (aka the launcher).
- You have the following installed command tools in your launcher: `make`, `docker`, `kubectl`, `helm`, `jq`.
- You have access to the built container images and Helm charts.

## Procedure

Deploy Spotfire steps:
1. Preparation
2. Install the Spotfire Database
3. Install the Spotfire Server
4. Install the Spotfire services

**Note**: For this example, we use containers to deploy the PostgreSQL database server that will host the Spotfire Database.
Anyhow, you can use any of the Spotfire supported databases, deployed as containers, VMs, bare metal or as a cloud service.

### Preparation

1. Create a namespace for the Spotfire deployment:

    ```bash
    export NAMESPACE=chocolate
    kubectl create namespace $NAMESPACE
    ```

2. We need access to the Spotfire container images.
   Set the `$REGISTRY` variable to point to your private registry where you pushed the Spotfire container images.
   
   Example: For Minikube:
    ```bash
    export REGISTRY=127.0.0.1:5000
    ```
   Example: For microk8s:
    ```bash
    export REGISTRY=127.0.0.1:32000
    ```
   **Note**: You can find other REGISTRY examples in this repo for the quickstarts for deploying Spotfire on K8s on AWS, Azure or Google Cloud.

3. We need access to the Spotfire Helm charts.
    ```bash
    cd <spotfire-cloud-deployment-kit>/helm/
    ```
   **Note**: For simplicity, in this example we deploy the Helm charts directly from the `packages` directory within the cloned Spotfire CDK repo.

### Install the Spotfire Database

Install a database server using [Bitnami's PostgreSQL chart](https://artifacthub.io/packages/helm/bitnami/postgresql) for the Spotfire database.

1. Add Bitnami Helm repo for Postgresql chart:
    ```bash
    helm repo add bitnami https://charts.bitnami.com/bitnami
    ```
2. Install the database server:
    ```bash 
    export SFDB_RELEASE=vanilla-sfdb
    helm -n $NAMESPACE install $SFDB_RELEASE bitnami/postgresql --set primary.persistence.enabled=false
    ```
3. Export Postgresql autogenerated random password:
    ```bash
    export POSTGRES_PASSWORD=$(kubectl get secret --namespace $NAMESPACE vanilla-sfdb-postgresql -o jsonpath="{.data.postgres-password}" | base64 --decode)
    ```

### Install the Spotfire Server

1. Install Spotfire Server chart using the release name `vanilla-sfs`:

   **Note**: The argument with custom values YAML file in the example below is not required, it is only showed for educational purposes.
   You can set the chart values either in the command line or in a custom values file. Or use both.
   You could for example include all the your command line value settings within your custom values file.

    ```bash
    cd <spotfire-cloud-deployment-kit>/helm/
    export SFS_RELEASE=vanilla-sfs
    helm -n $NAMESPACE upgrade --install ${SFS_RELEASE} charts/spotfire-server \
        --set global.spotfire.acceptEUA=true \
        --set global.spotfire.image.registry=$REGISTRY \
        --set global.spotfire.image.pullPolicy="Always" \
        --set database.bootstrap.databaseUrl="jdbc:postgresql://${SFDB_RELEASE}-postgresql/" \
        --set database.bootstrap.driverClass="org.postgresql.Driver" \
        --set database.create-db.databaseUrl="jdbc:postgresql://${SFDB_RELEASE}-postgresql/" \
        --set database.create-db.adminUsername="postgres" \
        --set database.create-db.adminPassword="$POSTGRES_PASSWORD" \
        --set database.create-db.enabled=true \
        --set configuration.site.publicAddress=http://spotfire.local \
        --set ingress.enabled=true \
        -f my-sfs-values.yaml
    ```
   
2. To review the deployment status:
    ```bash
    helm -n $NAMESPACE ls 
    helm -n $NAMESPACE status vanilla-sfs
    ```
    
3. To see user supplied values of the current installation, use:
    ```bash
    helm -n $NAMESPACE get values vanilla-sfs
    ```
    **Note**: This can be useful when piping it to a values file if one wants to reuse them later in some form with `helm ... --values values.yaml`

4. Get the Spotfire web UI credentials:
    ```bash
    export SPOTFIREADMIN_USERNAME=$(helm -n $NAMESPACE show values charts/spotfire-server --jsonpath {.configuration.spotfireAdmin.username})
    export SPOTFIREADMIN_PASSWORD=$(kubectl -n $NAMESPACE get secrets $SFS_RELEASE-spotfire-server -o jsonpath="{.data.SPOTFIREADMIN_PASSWORD}" | base64 --decode)
    echo -e "Spotfire UI:\n  - SPOTFIREADMIN_USERNAME: '${SPOTFIREADMIN_USERNAME}'\n  - SPOTFIREADMIN_PASSWORD: '${SPOTFIREADMIN_PASSWORD}'"
    ```

5. The Spotfire web UI might take 1-2 minutes to be available. 
   - You can follow the Spotfire config job:
      ```bash
      kubect -n $NAMESPACE logs -f <pod/vanilla-sfs-config-job>
      ```
   - You can follow the Spotfire Server startup process:
      ```bash
      kubectl -n $NAMESPACE logs -f service/$SFS_RELEASE-spotfire-server
      ```

6. When ready, access Spotfire web UI: http://spotfire.local and log in with the credentials from previous step:

    A. If you have direct access to the K8s cluster, you can add `spotfire.local` pointing to your K8s IP address into your `hosts` file:
    ```bash
    123.45.67.89 spotfire.local
    ```

    B. If you do not have direct access to the K8s cluster IP, you can add `spotfire.local` pointing to your localhost into your `hosts` file:
    ```bash
    127.0.0.1 localhost spotfire.local
    ```
    And create a SSH port forwarding tunnel from your laptop towards the K8s IP address in a host with access to K8s IP (for example, a jumphost or VM host where you installed minikube, microK8s or some other K8s distro):
    ```bash
    ssh -L 80:$K8S_IP:80 $MY_USER@$MY_VM_IP
    ```
    For example:
    ```bash
    ssh -L 80:123.45.67.89:80 my-user@my-test-server.acme.com
    ```

### Install Spotfire services: Web Player, Automation Services, TERR Service, Python Service

1. In order to install a Spotfire service, you need to get the `spotfire-server` pod. 
   Run the bellow commands to set the `SPOTFIRE_SERVER` and `LOG_FORWARDER` (assuming you have installed the Spotfire server in that namespace).
    ```bash
    export SPOTFIRE_SERVER=$(kubectl -n $NAMESPACE get services --selector=app.kubernetes.io/part-of=spotfire,app.kubernetes.io/name=spotfire-server --output=jsonpath={.items..metadata.name})
    export LOG_FORWARDER=$(kubectl -n $NAMESPACE get services --selector=app.kubernetes.io/part-of=spotfire,app.kubernetes.io/name=log-forwarder --output=jsonpath={.items..metadata.name})
    ```
   
2. Install the Spotfire services.

   **Note**: The arguments with custom values YAML file in the examples below are not required, it is only showed for educational purposes.
   You can set the chart values either in the command line or in a custom values file. Or use both.
   You could for example include all the your command line value settings within your custom values file.

    ```bash
    # Web player
    helm -n $NAMESPACE install vanilla-sfwp charts/spotfire-webplayer \
        --set global.spotfire.acceptEUA=true \
        --set global.spotfire.image.registry=${REGISTRY} \
        --set global.spotfire.image.pullPolicy="Always" \
        --set nodemanagerConfig.serverBackendAddress="${SPOTFIRE_SERVER:?}" \
        --set logging.logForwarderAddress="${LOG_FORWARDER:?}" \
        -f my-sfwp-values.yaml
   
    # Automation services
    helm -n $NAMESPACE upgrade --install vanilla-sfas charts/spotfire-automationservices \
        --set global.spotfire.acceptEUA=true \
        --set global.spotfire.image.registry=${REGISTRY} \
        --set global.spotfire.image.pullPolicy="Always" \
        --set nodemanagerConfig.serverBackendAddress="${SPOTFIRE_SERVER:?}" \
        --set logging.logForwarderAddress="${LOG_FORWARDER:?}" \
        -f sfas-values.yaml
   
    # Python service
    helm -n $NAMESPACE upgrade --install vanilla-sfpy charts/spotfire-pythonservice \
        --set global.spotfire.acceptEUA=true \
        --set global.spotfire.image.registry=${REGISTRY} \
        --set global.spotfire.image.pullPolicy="Always" \
        --set nodemanagerConfig.serverBackendAddress="${SPOTFIRE_SERVER:?}" \
        --set logging.logForwarderAddress="${LOG_FORWARDER:?}" \
        -f sfpy-values.yaml
   
    # Open Source R service
    helm -n $NAMESPACE upgrade --install vanilla-sfosr charts/spotfire-rservice \
        --set global.spotfire.acceptEUA=true \
        --set global.spotfire.image.registry=${REGISTRY} \
        --set global.spotfire.image.pullPolicy="Always" \
        --set nodemanagerConfig.serverBackendAddress="${SPOTFIRE_SERVER:?}" \
        --set logging.logForwarderAddress="${LOG_FORWARDER:?}" \
        -f sfosr-values.yaml
   
    # Spotfire Enterprise Runtime R (TERR) service
    helm -n $NAMESPACE upgrade --install vanilla-sferr charts/spotfire-terrservice \
        --set global.spotfire.acceptEUA=true \
        --set global.spotfire.image.registry=${REGISTRY} \
        --set global.spotfire.image.pullPolicy="Always" \
        --set nodemanagerConfig.serverBackendAddress="${SPOTFIRE_SERVER:?}" \
        --set logging.logForwarderAddress="${LOG_FORWARDER:?}" \
        -f sferr-values.yaml
    ```

## Tips

It is good to keep another terminal open with a look into the services and pods.

Example: Refresh every 5 secs the elements in the namespace `$NAMESPACE`:
```bash
watch -n 5 kubectl -n $NAMESPACE get all
```

Example: Refresh every 5 secs the resource utilization by the pods in the namespace `$NAMESPACE`:
```bash
watch -n 5 kubectl -n $NAMESPACE top pod
```

For more info, see the [kubectl syntax](https://kubernetes.io/docs/reference/kubectl/) and [kubectl cheatsheet](https://kubernetes.io/docs/reference/kubectl/cheatsheet/).

## Uninstall Spotfire

1. List the deployed releases:
    ```bash
    helm -n $NAMESPACE ls
    ```
2. Uninstall the Spotfire releases:
    ```bash
    helm -n $NAMESPACE uninstall vanilla-sfs vanilla-sfdb vanilla-sfwp vanilla-sfsas vanilla-sfpy vanilla-sfosr vanilla-sferr
    ```
